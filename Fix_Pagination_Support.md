# æ·»åŠ åˆ†é¡µæ”¯æŒ

## ğŸ› é—®é¢˜

```
ä»Šå¤©æœ‰3æ¡å¹³ä»“è®°å½•
ä½†åªè·å–åˆ°2æ¡
```

## ğŸ” åŸå› 

Bybit APIä½¿ç”¨åˆ†é¡µè¿”å›æ•°æ®ï¼š
- é»˜è®¤æ¯é¡µæœ€å¤šè¿”å›100æ¡
- å¦‚æœæ•°æ®è¶…è¿‡100æ¡ï¼Œéœ€è¦ä½¿ç”¨`cursor`åˆ†é¡µè·å–
- ä¹‹å‰çš„ä»£ç åªè·å–ç¬¬ä¸€é¡µ

## âœ… ä¿®å¤

### ä¿®æ”¹å‰

```python
response = self.client.get_closed_pnl(**params)
pnl_list = response["result"].get("list", [])
return pnl_list  # åªè¿”å›ç¬¬ä¸€é¡µ
```

### ä¿®æ”¹å

```python
# åˆ†é¡µè·å–æ‰€æœ‰è®°å½•
all_pnl_list = []
cursor = None

while True:
    if cursor:
        params["cursor"] = cursor
    
    response = self.client.get_closed_pnl(**params)
    result = response["result"]
    pnl_list = result.get("list", [])
    all_pnl_list.extend(pnl_list)
    
    # æ£€æŸ¥æ˜¯å¦è¿˜æœ‰æ›´å¤šæ•°æ®
    cursor = result.get("nextPageCursor")
    if not cursor or len(pnl_list) == 0:
        break
    
    logger.debug(f"ç»§ç»­è·å–ä¸‹ä¸€é¡µï¼Œcursor={cursor}")

return all_pnl_list  # è¿”å›æ‰€æœ‰é¡µçš„æ•°æ®
```

## ğŸ“Š å·¥ä½œåŸç†

### Bybitåˆ†é¡µæœºåˆ¶

```
ç¬¬1æ¬¡è¯·æ±‚:
  â”œâ”€ è¿”å›100æ¡è®°å½•
  â””â”€ nextPageCursor: "abc123"

ç¬¬2æ¬¡è¯·æ±‚ (cursor="abc123"):
  â”œâ”€ è¿”å›100æ¡è®°å½•
  â””â”€ nextPageCursor: "def456"

ç¬¬3æ¬¡è¯·æ±‚ (cursor="def456"):
  â”œâ”€ è¿”å›50æ¡è®°å½•
  â””â”€ nextPageCursor: "" (ç©ºï¼Œè¡¨ç¤ºæ²¡æœ‰æ›´å¤šæ•°æ®)
```

### æ–°çš„è·å–æµç¨‹

```
1. å‘èµ·ç¬¬1æ¬¡è¯·æ±‚
   â†“
2. è·å–100æ¡è®°å½•
   â†“
3. æ£€æŸ¥nextPageCursor
   â”œâ”€ æœ‰cursor â†’ ç»§ç»­è¯·æ±‚ä¸‹ä¸€é¡µ
   â””â”€ æ— cursor â†’ ç»“æŸ
   â†“
4. è¿”å›æ‰€æœ‰è®°å½•
```

## ğŸ“ æ—¥å¿—ç¤ºä¾‹

### å•é¡µæ•°æ®

```
è·å–å·²å¹³ä»“ç›ˆäºè®°å½•: {'category': 'linear', 'limit': 100, ...}
è·å–åˆ°3æ¡å¹³ä»“è®°å½•
```

### å¤šé¡µæ•°æ®

```
è·å–å·²å¹³ä»“ç›ˆäºè®°å½•: {'category': 'linear', 'limit': 100, ...}
ç»§ç»­è·å–ä¸‹ä¸€é¡µï¼Œcursor=abc123
ç»§ç»­è·å–ä¸‹ä¸€é¡µï¼Œcursor=def456
è·å–åˆ°250æ¡å¹³ä»“è®°å½•
```

## ğŸ”§ ä¿®å¤çš„API

### 1. get_closed_pnl()

```python
# å¹³ä»“è®°å½• - æ”¯æŒåˆ†é¡µ
all_pnl_list = []
while True:
    response = self.client.get_closed_pnl(**params)
    pnl_list = result.get("list", [])
    all_pnl_list.extend(pnl_list)
    
    cursor = result.get("nextPageCursor")
    if not cursor:
        break
```

### 2. get_order_history()

```python
# è®¢å•å†å² - æ”¯æŒåˆ†é¡µ
all_orders = []
while True:
    response = self.client.get_order_history(**params)
    orders = result.get("list", [])
    all_orders.extend(orders)
    
    cursor = result.get("nextPageCursor")
    if not cursor:
        break
```

## âœ… ç°åœ¨å¯ä»¥è·å–æ‰€æœ‰è®°å½•

### ä¹‹å‰

```
limit=100
â”œâ”€ ç¬¬1-100æ¡ âœ…
â””â”€ ç¬¬101+æ¡ âŒ ä¸¢å¤±
```

### ç°åœ¨

```
limit=100 + åˆ†é¡µ
â”œâ”€ ç¬¬1-100æ¡ âœ…
â”œâ”€ ç¬¬101-200æ¡ âœ…
â”œâ”€ ç¬¬201-300æ¡ âœ…
â””â”€ ... æ‰€æœ‰è®°å½• âœ…
```

## ğŸ¯ å®é™…æ•ˆæœ

### åœºæ™¯1: å°‘é‡æ•°æ®ï¼ˆ<100æ¡ï¼‰

```
ç¬¬1æ¬¡è¯·æ±‚ â†’ è·å–3æ¡ â†’ æ— nextPageCursor â†’ å®Œæˆ
æ€»è®¡: 3æ¡ âœ…
```

### åœºæ™¯2: å¤§é‡æ•°æ®ï¼ˆ>100æ¡ï¼‰

```
ç¬¬1æ¬¡è¯·æ±‚ â†’ è·å–100æ¡ â†’ cursor=abc123
ç¬¬2æ¬¡è¯·æ±‚ â†’ è·å–100æ¡ â†’ cursor=def456
ç¬¬3æ¬¡è¯·æ±‚ â†’ è·å–50æ¡ â†’ æ— cursor
æ€»è®¡: 250æ¡ âœ…
```

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. APIè°ƒç”¨æ¬¡æ•°

åˆ†é¡µä¼šå¢åŠ APIè°ƒç”¨æ¬¡æ•°ï¼š
```
100æ¡æ•°æ® = 1æ¬¡è°ƒç”¨
200æ¡æ•°æ® = 2æ¬¡è°ƒç”¨
300æ¡æ•°æ® = 3æ¬¡è°ƒç”¨
```

### 2. æ—¶é—´èŒƒå›´

å¦‚æœæ—¶é—´èŒƒå›´å¤ªé•¿ï¼Œå¯èƒ½æœ‰å¾ˆå¤šæ•°æ®ï¼š
```
7å¤© = å¯èƒ½å‡ ç™¾æ¡
30å¤© = å¯èƒ½å‡ åƒæ¡
```

å»ºè®®ï¼š
- æ¯30ç§’åŒæ­¥æœ€è¿‘7å¤© âœ…
- é¦–æ¬¡åŒæ­¥å¯ä»¥ç”¨30å¤©

### 3. æ€§èƒ½

åˆ†é¡µè·å–ä¼šç¨å¾®æ…¢ä¸€äº›ï¼š
```
å•é¡µ: ~1ç§’
3é¡µ: ~3ç§’
```

ä½†èƒ½ä¿è¯æ•°æ®å®Œæ•´æ€§ï¼

## ğŸ” éªŒè¯

### é‡å¯åæŸ¥çœ‹æ—¥å¿—

```
è·å–å·²å¹³ä»“ç›ˆäºè®°å½•: {...}
ç»§ç»­è·å–ä¸‹ä¸€é¡µï¼Œcursor=xxx  â† å¦‚æœæœ‰è¿™è¡Œï¼Œè¯´æ˜åœ¨åˆ†é¡µ
è·å–åˆ°3æ¡å¹³ä»“è®°å½•  â† ç°åœ¨æ˜¯æ‰€æœ‰è®°å½•çš„æ€»æ•°
```

### æ£€æŸ¥æ•°æ®åº“

```sql
-- æŸ¥çœ‹ä»Šå¤©çš„å¹³ä»“è®°å½•
SELECT * FROM trading_pnl_history 
WHERE user_id = 4 
AND DATE(close_time) = CURDATE()
ORDER BY close_time DESC;

-- åº”è¯¥çœ‹åˆ°3æ¡è®°å½• âœ…
```

## âœ… æ€»ç»“

- âœ… æ·»åŠ äº†åˆ†é¡µæ”¯æŒ
- âœ… å¯ä»¥è·å–æ‰€æœ‰è®°å½•ï¼ˆä¸é™äº100æ¡ï¼‰
- âœ… å¹³ä»“è®°å½•å’Œè®¢å•è®°å½•éƒ½æ”¯æŒ
- âœ… è‡ªåŠ¨å¤„ç†å¤šé¡µæ•°æ®

**ç°åœ¨å¯ä»¥è·å–æ‰€æœ‰çš„å†å²è®°å½•äº†ï¼** ğŸ‰
